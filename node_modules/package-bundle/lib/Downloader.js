'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _slicedToArray2 = require('babel-runtime/helpers/slicedToArray');

var _slicedToArray3 = _interopRequireDefault(_slicedToArray2);

var _getPrototypeOf = require('babel-runtime/core-js/object/get-prototype-of');

var _getPrototypeOf2 = _interopRequireDefault(_getPrototypeOf);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _get2 = require('babel-runtime/helpers/get');

var _get3 = _interopRequireDefault(_get2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

var _request = require('request');

var _request2 = _interopRequireDefault(_request);

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _mkdirp = require('mkdirp');

var _mkdirp2 = _interopRequireDefault(_mkdirp);

var _rimraf = require('rimraf');

var _rimraf2 = _interopRequireDefault(_rimraf);

var _crypto = require('crypto');

var _crypto2 = _interopRequireDefault(_crypto);

var _stream = require('stream');

var _PBError = require('./PBError');

var _PBError2 = _interopRequireDefault(_PBError);

var _PBRequest = require('./PBRequest');

var _PBRequest2 = _interopRequireDefault(_PBRequest);

var _Step2 = require('./Step');

var _Step3 = _interopRequireDefault(_Step2);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var rm = _bluebird2.default.promisify(_rimraf2.default);
var mkdir = _bluebird2.default.promisify(_mkdirp2.default);
var OUT_DIR = '.package-bundle';

var Downloader = function (_Step) {
  (0, _inherits3.default)(Downloader, _Step);
  (0, _createClass3.default)(Downloader, null, [{
    key: 'cleanUp',
    value: function cleanUp() {
      return rm(OUT_DIR);
    }
  }]);

  function Downloader(args) {
    (0, _classCallCheck3.default)(this, Downloader);

    var _this = (0, _possibleConstructorReturn3.default)(this, (Downloader.__proto__ || (0, _getPrototypeOf2.default)(Downloader)).call(this, args, 2, 'Downloading packages'));

    _this.args = args;
    _this.totalSize = 0;
    return _this;
  }

  (0, _createClass3.default)(Downloader, [{
    key: 'init',
    value: function init(downloads) {
      var _this2 = this;

      (0, _get3.default)(Downloader.prototype.__proto__ || (0, _getPrototypeOf2.default)(Downloader.prototype), 'init', this).call(this, downloads.size);
      this.downloads = downloads;

      return _bluebird2.default.map(this.downloads.entries(), function (_ref) {
        var _ref2 = (0, _slicedToArray3.default)(_ref, 2),
            _ref2$ = _ref2[1],
            name = _ref2$.name,
            version = _ref2$.version,
            dist = _ref2$.dist;

        return _this2.getPackage(name, version, dist);
      }, { concurrency: this.args.concurrency || 50 }).then(function () {
        return _this2.complete('Downloaded packages');
      });
    }
  }, {
    key: 'getPackage',
    value: function getPackage(pkg, version, _ref3) {
      var _this3 = this;

      var shasum = _ref3.shasum,
          tarball = _ref3.tarball;

      var outDir = this.args.archive ? OUT_DIR : OUT_DIR.substring(1);
      var folder = this.args.flat ? outDir : outDir + '/' + pkg + '/-';
      var stripped = pkg.includes('/') && (this.args.flat ? pkg.replace('/', '-') : pkg.split('/')[1]);
      var strippedName = stripped || pkg;
      var hash = _crypto2.default.createHash('sha1');
      var reqOptions = (0, _PBRequest2.default)(this.args, tarball);
      hash.setEncoding('hex');
      return mkdir(folder).then(function () {
        return new _bluebird2.default(function (resolve, reject) {
          var hashPass = new _stream.PassThrough(); // eslint-disable-line

          hashPass.pipe(hash).on('finish', function () {
            var hashResult = hash.read();
            if (hashResult !== shasum) {
              reject(new _PBError2.default('sha1 hashes do not match for ' + pkg + '@' + version + '\nDownloaded (' + hashResult + ')} does not equal provided (' + shasum + ')'));
            } else {
              _this3.tick(1);
              resolve();
            }
          });
          (0, _request2.default)(reqOptions).on('error', function () {
            return reject();
          }).on('response', function (res) {
            var size = parseInt(res.headers['content-length'], 10);
            _this3.totalSize += size;
          }).pipe(hashPass).pipe(_fs2.default.createWriteStream(folder + '/' + strippedName + '-' + version + '.tgz'));
        });
      });
    }
  }]);
  return Downloader;
}(_Step3.default);

exports.default = Downloader;